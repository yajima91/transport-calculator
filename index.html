<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>JITBOXãƒãƒ£ãƒ¼ã‚¿ãƒ¼ä¾¿æ–™é‡‘ã€€è‡ªå‹•è¨ˆç®—</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
<style>
  :root {
    --bg: #0f1117; --surface: #1a1d27; --surface2: #22263a;
    --border: #2e3350; --accent: #4f8ef7; --accent2: #7c5cfc;
    --success: #3dd68c; --warn: #f7c94f; --text: #e8eaf6;
    --muted: #7b82a8; --radius: 14px;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    background: var(--bg); color: var(--text);
    font-family: 'Noto Sans JP', sans-serif;
    padding: 40px 16px 80px; display: flex; flex-direction: column; align-items: center;
  }
  header { text-align: center; margin-bottom: 40px; }
  .logo-mark {
    display: inline-flex; align-items: center; gap: 10px;
    font-family: 'DM Mono', monospace; font-size: 12px; color: var(--accent);
    letter-spacing: 0.15em; text-transform: uppercase; margin-bottom: 16px;
    background: rgba(79,142,247,.10); padding: 6px 14px; border-radius: 100px; border: 1px solid rgba(79,142,247,.25);
  }
  h1 { font-size: clamp(24px, 5vw, 36px); font-weight: 700; background: linear-gradient(135deg, #fff 30%, var(--accent)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; line-height: 1.25; }
  
  .card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 28px; width: 100%; max-width: 520px; }
  .card + .card { margin-top: 16px; }

  /* Setup & QR Area */
  #setup-banner { background: linear-gradient(135deg, rgba(79,142,247,.1), rgba(124,92,252,.1)); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; max-width: 520px; width: 100%; margin-bottom: 16px; }
  .setup-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
  #gas-url-input { width: 100%; background: rgba(0,0,0,.3); border: 1px solid var(--border); border-radius: 8px; padding: 10px; color: var(--text); font-size: 12px; font-family: 'DM Mono'; margin-bottom: 10px; }
  
  /* QR Scanner View */
  #qr-container { display: none; position: relative; width: 100%; border-radius: 12px; overflow: hidden; margin: 10px 0; border: 2px solid var(--accent); }
  #qr-video { width: 100%; height: auto; display: block; }
  .qr-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; box-shadow: inset 0 0 100px rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; }
  .qr-target { width: 200px; height: 200px; border: 2px solid var(--accent); border-radius: 20px; background: rgba(79,142,247,0.1); }

  /* Form & Results */
  .form-grid { display: grid; gap: 14px; }
  .origin-fixed { background: var(--surface2); border: 1px solid var(--border); border-radius: 10px; padding: 12px; font-weight: 700; display: flex; justify-content: space-between; }
  label { font-size: 12px; color: var(--muted); margin-bottom: 4px; display: block; }
  select, input[type="number"] { background: var(--surface2); border: 1px solid var(--border); border-radius: 10px; padding: 12px; color: var(--text); width: 100%; font-size: 16px; }
  .btn { width: 100%; padding: 15px; border: none; border-radius: 10px; font-size: 16px; font-weight: 700; cursor: pointer; background: linear-gradient(135deg, var(--accent), var(--accent2)); color: #fff; margin-top: 10px; }
  .btn:disabled { opacity: 0.5; }
  .btn-qr { background: var(--surface2); border: 1px solid var(--accent); color: var(--accent); padding: 8px 12px; border-radius: 8px; font-size: 13px; cursor: pointer; }
  
  #result-card { display: none; }
  #result-card.show { display: block; }
  .total-row { padding: 16px; background: rgba(61,214,140,0.1); border: 1px solid var(--success); border-radius: 10px; display: flex; justify-content: space-between; align-items: baseline; }
  .total-amount { font-family: 'DM Mono'; font-size: 28px; color: var(--success); }
  .error-box { background: rgba(239,68,68,0.1); color: #f87171; padding: 12px; border-radius: 8px; font-size: 13px; margin: 10px 0; display: none; }
  .error-box.show { display: block; }
</style>
</head>
<body>

<header>
  <div class="logo-mark">ğŸšš JITBOX Charter</div>
  <h1>æ–™é‡‘ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼</h1>
</header>

<div id="setup-banner">
  <div class="setup-header">
    <span style="font-size: 13px; font-weight: 700;">âš™ï¸ æ¥ç¶šè¨­å®š</span>
    <button class="btn-qr" id="scan-btn" onclick="toggleScanner()">ğŸ“· QRã‚¹ã‚­ãƒ£ãƒ³</button>
  </div>
  
  <div id="qr-container">
    <video id="qr-video"></video>
    <div class="qr-overlay"><div class="qr-target"></div></div>
  </div>

  <input type="url" id="gas-url-input" placeholder="GASã®URLã‚’è²¼ã‚Šä»˜ã‘ã€ã¾ãŸã¯QRã‚¹ã‚­ãƒ£ãƒ³">
  <button class="btn" style="padding: 10px; font-size: 14px;" onclick="loadMaster()" id="load-master-btn">ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€</button>
</div>

<div class="card">
  <div class="form-grid">
    <div>
      <label>ç™ºåœ°ï¼ˆå›ºå®šï¼‰</label>
      <div class="origin-fixed">æ„›çŸ¥çœŒ <span style="color:var(--accent); font-size:11px;">ORIGIN</span></div>
    </div>
    <div>
      <label>ç€åœ°ã‚¨ãƒªã‚¢</label>
      <select id="destination"><option value="">-- ãƒã‚¹ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„ --</option></select>
    </div>
    <div>
      <label>å€‹æ•°ï¼ˆã‚«ã‚´æ•°ï¼‰</label>
      <input type="number" id="quantity" value="1" min="1">
    </div>
  </div>
  <div class="error-box" id="error-box"></div>
  <button class="btn" id="calc-btn" onclick="calculate()" disabled>è¨ˆç®—ã‚’å®Ÿè¡Œ</button>
</div>

<div class="card" id="result-card">
  <div style="font-size:12px; color:var(--muted); margin-bottom:15px;">è¨ˆç®—çµæœ</div>
  <div style="display:flex; justify-content:space-between; margin-bottom:20px; font-weight:700;">
    <span id="res-origin"></span> â†’ <span id="res-dest"></span>
  </div>
  <div style="font-size:14px; line-height:2;">
    <div style="display:flex; justify-content:space-between;"><span style="color:var(--muted);">è¼¸é€è²»å°è¨ˆ</span><span id="res-transport-total"></span></div>
    <div style="display:flex; justify-content:space-between;"><span style="color:var(--muted);">æ¢±åŒ…è²»åˆè¨ˆ</span><span id="res-packing-total"></span></div>
  </div>
  <hr style="border:none; border-top:1px solid var(--border); margin:15px 0;">
  <div class="total-row">
    <span style="font-size:13px;">åˆè¨ˆ(ç¨æŠœ)</span>
    <span class="total-amount" id="res-total"></span>
  </div>
</div>

<script>
  const GAS_URL_KEY = 'transport_gas_url';
  let videoStream = null;

  window.addEventListener('DOMContentLoaded', () => {
    const saved = localStorage.getItem(GAS_URL_KEY);
    if (saved) document.getElementById('gas-url-input').value = saved;
  });

  // --- QR Scanner Logic ---
  async function toggleScanner() {
    const container = document.getElementById('qr-container');
    const scanBtn = document.getElementById('scan-btn');
    
    if (videoStream) {
      stopScanner();
      return;
    }

    try {
      videoStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
      const video = document.getElementById('qr-video');
      video.srcObject = videoStream;
      video.setAttribute("playsinline", true);
      video.play();
      container.style.display = 'block';
      scanBtn.textContent = 'âœ• åœæ­¢';
      requestAnimationFrame(tick);
    } catch (err) {
      alert("ã‚«ãƒ¡ãƒ©ã®èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸã€‚HTTPSæ¥ç¶šã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
    }
  }

  function tick() {
    const video = document.getElementById('qr-video');
    if (video.readyState === video.HAVE_ENOUGH_DATA) {
      const canvas = document.createElement("canvas");
      canvas.height = video.videoHeight;
      canvas.width = video.videoWidth;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const code = jsQR(imageData.data, imageData.width, imageData.height);

      if (code && code.data.startsWith('http')) {
        document.getElementById('gas-url-input').value = code.data;
        stopScanner();
        loadMaster();
        return;
      }
    }
    if (videoStream) requestAnimationFrame(tick);
  }

  function stopScanner() {
    if (videoStream) {
      videoStream.getTracks().forEach(track => track.stop());
      videoStream = null;
    }
    document.getElementById('qr-container').style.display = 'none';
    document.getElementById('scan-btn').textContent = 'ğŸ“· QRã‚¹ã‚­ãƒ£ãƒ³';
  }

  // --- API Logic ---
  async function loadMaster() {
    const url = document.getElementById('gas-url-input').value.trim();
    if (!url) return;
    localStorage.setItem(GAS_URL_KEY, url);
    
    const btn = document.getElementById('load-master-btn');
    btn.disabled = true;
    btn.textContent = 'èª­ã¿è¾¼ã¿ä¸­...';

    try {
      const res = await fetch(`${url}?action=getMaster`);
      const data = await res.json();
      const destSel = document.getElementById('destination');
      destSel.innerHTML = '<option value="">ç€åœ°ã‚’é¸æŠ</option>';
      data.destinations.forEach(d => {
        destSel.innerHTML += `<option value="${d}">${d}</option>`;
      });
      document.getElementById('calc-btn').disabled = false;
      btn.textContent = 'âœ“ èª­è¾¼å®Œäº†';
    } catch (e) {
      alert("ã‚¨ãƒ©ãƒ¼: URLãŒæ­£ã—ã„ã‹ã€GASã®ãƒ‡ãƒ—ãƒ­ã‚¤è¨­å®šãŒã€Œå…¨å“¡ã€ã«ãªã£ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
      btn.disabled = false;
      btn.textContent = 'ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€';
    }
  }

  async function calculate() {
    const url = localStorage.getItem(GAS_URL_KEY);
    const dest = document.getElementById('destination').value;
    const qty = document.getElementById('quantity').value;
    
    if (!dest) { showError("ç€åœ°ã‚’é¸æŠã—ã¦ãã ã•ã„"); return; }
    showError("");

    const btn = document.getElementById('calc-btn');
    btn.disabled = true;
    btn.textContent = "è¨ˆç®—ä¸­...";

    try {
      const res = await fetch(`${url}?action=calculate&origin=æ„›çŸ¥çœŒ&destination=${encodeURIComponent(dest)}&quantity=${qty}`);
      const d = await res.json();
      
      const fmt = n => 'Â¥' + Number(n).toLocaleString();
      document.getElementById('res-origin').textContent = d.origin;
      document.getElementById('res-dest').textContent = d.destination;
      document.getElementById('res-transport-total').textContent = fmt(d.transportTotal);
      document.getElementById('res-packing-total').textContent = fmt(d.packingTotal);
      document.getElementById('res-total').textContent = fmt(d.total);
      
      document.getElementById('result-card').classList.add('show');
    } catch (e) {
      showError("è¨ˆç®—ã«å¤±æ•—ã—ã¾ã—ãŸ");
    }
    btn.disabled = false;
    btn.textContent = "è¨ˆç®—ã‚’å®Ÿè¡Œ";
  }

  function showError(m) {
    const b = document.getElementById('error-box');
    b.textContent = m;
    b.classList.toggle('show', !!m);
  }
</script>
</body>
</html>